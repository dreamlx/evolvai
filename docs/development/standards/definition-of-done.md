# Definition of Done (DoD) - 完成定义清单

**版本**: 1.0
**创建日期**: 2025-10-27
**状态**: [ACTIVE]
**适用范围**: 所有Epic、Feature、Story、Task

---

## 📋 总则

**DoD的作用**：
- 确保交付物满足质量标准
- 统一团队对"完成"的理解
- 防止技术债务累积
- 支持持续交付和快速迭代

**使用原则**：
- ✅ 所有条目必须可验证（有明确标准）
- ✅ 根据工作项类型选择适用的清单
- ✅ 特殊情况可豁免，但需记录原因
- ✅ DoD是最低标准，鼓励超越

---

## 🎯 Epic级别DoD

### Epic-001: 行为约束系统 (Behavior Constraints)

**功能完整性**:
- [ ] safe_search实现完成（limit + timeout + dry_run）
- [ ] safe_edit实现完成（patch-first + git worktree + 受影响测试）
- [ ] safe_exec实现完成（沙箱 + 资源限制）
- [ ] ExecutionPlan Schema定义并验证
- [ ] 分批策略实现（file_level + hunk_level）

**质量标准**:
- [ ] 单元测试覆盖率 ≥ 90%
- [ ] 集成测试覆盖核心场景（3仓 × 3任务 = 9场景）
- [ ] 性能基准达标（P95延迟、吞吐量）
- [ ] 错误恢复测试通过（回滚、熔断、超时）

**TPST验证**:
- [ ] 对比基线TPST降低 ≥ 30%
- [ ] 首次成功率 ≥ 70%
- [ ] 返工次数降低 ≥ 50%

**文档完整性**:
- [ ] API文档完整（所有MCP工具）
- [ ] 使用指南（含示例）
- [ ] 故障排查手册

**集成验证**:
- [ ] 与Epic-003集成测试通过（接收ExecutionPlan）
- [ ] 反馈闭环运行（Evidence事件回写）

---

### Epic-002: 项目规范即服务 (Project Standards as MCP)

**功能完整性**:
- [ ] .project_standards.yml Schema定义
- [ ] doc.suggest实现（位置建议 + 模板生成）
- [ ] doc.template实现（结构模板应用）
- [ ] doc.validate实现（位置 + 命名 + 结构校验）
- [ ] pre-commit守卫集成

**质量标准**:
- [ ] 位置建议准确率 ≥ 95%
- [ ] 模板完整性检查通过率 ≥ 90%
- [ ] 原则评分准确性（小模型可选）≥ 80%
- [ ] 单元测试覆盖率 ≥ 85%

**TPST验证**:
- [ ] 文档返工token降低 ≥ 40%
- [ ] 位置纠正次数降低 ≥ 80%

**文档完整性**:
- [ ] 规范Schema文档
- [ ] 使用手册（如何定义项目规范）
- [ ] 最佳实践指南

**集成验证**:
- [ ] 与Epic-003集成测试通过（接收DocPlan）
- [ ] 规范校验反馈闭环运行

---

### Epic-003: Graph-of-Thought引擎 (GoT Engine)

**功能完整性**:
- [ ] Session管理（start/checkpoint/restore）
- [ ] Event Store（append-only + WAL + 向量时钟）
- [ ] 并行分支（fork/parallel.run/merge）
- [ ] 早停策略（race/best/vote）
- [ ] Schema校验（ExecutionPlan/DocPlan）
- [ ] 预算控制（token/时间/分支数硬限制）
- [ ] 失败自愈（签名去重 + 策略匹配）
- [ ] Context优化（digest + Mermaid导出）

**质量标准**:
- [ ] 事件溯源可靠性 ≥ 99.9%
- [ ] Plan Schema通过率 ≥ 95%
- [ ] 并行分支收敛速度 ≥ 2x（对比串行）
- [ ] 单元测试覆盖率 ≥ 95%（核心模块）

**TPST验证**:
- [ ] 思考token占比从40%降至≤20%（MVP目标≤15%）
- [ ] 平均思考回合数从5-8降至≤3（最终≤2）
- [ ] 首次计划成功率 ≥ 75%（最终≥90%）

**文档完整性**:
- [ ] 技术架构文档
- [ ] MCP工具API文档（11个工具）
- [ ] 思维图谱可视化指南

**集成验证**:
- [ ] 输出ExecutionPlan给Epic-001并执行
- [ ] 输出DocPlan给Epic-002并校验
- [ ] 接收Evidence反馈并触发critic修订

**基准对比**:
- [ ] 3仓 × 3任务 = 9场景对比报告
- [ ] 公开复现脚本
- [ ] 性能数据可审计

---

## 📦 Feature级别DoD

**代码质量**:
- [ ] 所有代码遵循项目编码规范
- [ ] 无高危安全漏洞（运行安全扫描）
- [ ] 无明显性能问题（profiling通过）
- [ ] 代码审查通过（至少1人）

**测试要求**:
- [ ] 单元测试覆盖率 ≥ 85%
- [ ] 所有测试用例通过
- [ ] 边界条件测试覆盖
- [ ] 错误处理测试覆盖

**文档要求**:
- [ ] 函数/类文档字符串完整
- [ ] API使用示例完整
- [ ] 变更记录更新（CHANGELOG）

**集成要求**:
- [ ] 与依赖Feature集成测试通过
- [ ] 不破坏现有功能（回归测试）

---

## 🗓️ Sprint级别DoD

**代码和测试完成**:
- [ ] 所有计划Story已完成或移至下一Sprint
- [ ] 所有代码已合并到develop分支
- [ ] 所有测试通过（单元+集成）
- [ ] 代码格式化和类型检查通过

**文档归档（5S6A整理）**:
- [ ] **执行5S6A文档整理**（详见：[docs-5s6a-analysis.md](../tasks/docs-5s6a-analysis.md)）
  - [ ] 归档已完成Story文档：`sprints/current/` → `sprints/completed/sprint-{N}/`
  - [ ] 检查文档命名规范（story-X.X格式，无feature-X.X）
  - [ ] 整理knowledge/目录（analysis文档 → research/）
  - [ ] 清理临时测试文件和目录
- [ ] Sprint文档归档：移动到`sprints/completed/sprint-{N}/`
- [ ] 更新Sprint状态为[COMPLETED]

**Sprint回顾**:
- [ ] Sprint Review会议完成
- [ ] Sprint Retrospective完成
- [ ] 改进行动项记录到下一Sprint
- [ ] 经验教训文档化（lessons-learned/）

**下一Sprint准备**:
- [ ] 创建下一Sprint文档
- [ ] 未完成Story移至下一Sprint Backlog
- [ ] 更新产品Backlog优先级

---

## 📖 Story级别DoD

**功能实现**:
- [ ] 所有验收标准满足
- [ ] 用户故事完整可演示
- [ ] 边界条件处理正确

**代码质量**:
- [ ] 代码符合编码规范
- [ ] 通过静态分析（ruff/mypy）
- [ ] 无代码重复（DRY原则）

**测试要求**:
- [ ] 单元测试覆盖核心逻辑
- [ ] 测试用例可重复运行
- [ ] 测试数据独立（不依赖外部状态）

**文档要求**:
- [ ] 代码注释清晰
- [ ] 复杂逻辑有说明文档

---

## ✅ Task级别DoD

**实现完成**:
- [ ] 任务描述的功能实现完成
- [ ] 代码提交到正确分支
- [ ] 无编译/语法错误

**基础测试**:
- [ ] 本地手动测试通过
- [ ] 相关自动化测试通过

**代码检查**:
- [ ] 运行`uv run poe format`格式化代码
- [ ] 运行`uv run poe type-check`类型检查通过
- [ ] 运行`uv run poe lint`无严重警告

---

## 🧪 测试标准

### 单元测试

**覆盖率要求**:
- 核心模块（GoT引擎、safe_*工具）：≥ 95%
- 业务逻辑层：≥ 90%
- 辅助工具：≥ 80%
- 整体项目：≥ 85%

**测试质量**:
- [ ] 测试独立（不依赖执行顺序）
- [ ] 测试快速（单个测试 < 1秒）
- [ ] 测试清晰（命名描述测试内容）
- [ ] 测试维护性（易于更新）

### 集成测试

**覆盖场景**:
- [ ] 正常流程（happy path）
- [ ] 异常处理（error path）
- [ ] 边界条件（boundary cases）
- [ ] 并发场景（concurrency）

**验证标准**:
- [ ] 端到端流程可运行
- [ ] 跨Epic集成可运行
- [ ] 回滚机制有效

### 性能测试

**基准要求**:
- [ ] P50延迟 < 目标值
- [ ] P95延迟 < 目标值 × 2
- [ ] P99延迟 < 目标值 × 3
- [ ] 吞吐量 ≥ 目标值

**压力测试**:
- [ ] 长时间运行稳定（≥ 1小时）
- [ ] 并发场景无死锁
- [ ] 内存无明显泄漏

---

## 📊 TPST验证标准

> 📊 **权威指标定义**: 详见 [Metrics Reference](../../product/specs/metrics-reference.md)
> ⚠️  **注意**: 以下目标为假设性，需通过实验验证

### 基线建立

**对比场景**:
- [ ] 选择3个代表性仓库（小型/中型/大型）
- [ ] 选择3类任务（搜索/编辑/重构）
- [ ] 运行基线测试（无约束）
- [ ] 记录：总token、思考token、执行token、返工次数

**基线脚本**:
```bash
# 在docs/testing/benchmarks/下
./baseline-tpst.sh --repo <repo> --task <task> --iterations 5
```

### 优化验证

**对比测试**:
- [ ] 同样9个场景（3仓 × 3任务）
- [ ] 运行优化版本（启用Epic-001/002/003）
- [ ] 记录同样指标
- [ ] 生成对比报告

**通过标准**:
- Epic-003 MVP: TPST降低 ≥ 30%
- Epic-001 完成: TPST降低 ≥ 50%（累加Epic-003）
- 三Epic集成: TPST降低 ≥ 50%（保守目标）/ ≥ 70%（最终目标）

---

## 📝 文档标准

### API文档

**必须包含**:
- [ ] 工具名称和描述
- [ ] 参数列表（类型、必填、默认值）
- [ ] 返回值Schema
- [ ] 使用示例（≥2个）
- [ ] 错误处理说明

**格式要求**:
- [ ] 使用Markdown格式
- [ ] 代码示例可复制运行
- [ ] 链接到相关文档

### 使用指南

**必须包含**:
- [ ] 快速开始（5分钟可运行）
- [ ] 核心概念解释
- [ ] 常见场景示例
- [ ] 故障排查指南
- [ ] FAQ（至少5个问题）

### 架构文档

**必须包含**:
- [ ] 系统架构图
- [ ] 核心组件说明
- [ ] 数据流图
- [ ] 关键设计决策（ADR）
- [ ] 技术选型理由

---

## 🔧 工具配置检查

### 开发环境

**必须配置**:
- [ ] `uv`包管理器安装
- [ ] Python 3.11+环境
- [ ] 依赖安装（`uv sync`）
- [ ] pre-commit hooks安装

### 代码质量工具

**必须通过**:
- [ ] `uv run poe format` - 代码格式化
- [ ] `uv run poe type-check` - 类型检查
- [ ] `uv run poe lint` - 代码规范检查
- [ ] `uv run poe test` - 测试运行

---

## 🚀 发布标准

### MVP发布（Week 3）

**最小功能集**:
- [ ] Epic-003核心引擎可运行
- [ ] 单线性思维流程可用
- [ ] 输出ExecutionPlan可用
- [ ] 基础TPST对比完成

**质量门槛**:
- [ ] 无阻塞性bug
- [ ] 核心测试通过
- [ ] TPST降低 ≥ 30%

### 完整版发布（Week 6）

**完整功能集**:
- [ ] 三Epic完整实现
- [ ] 完整闭环运行
- [ ] 工程化能力完善

**质量门槛**:
- [ ] 所有Epic DoD满足
- [ ] 所有集成测试通过
- [ ] TPST降低 ≥ 50%
- [ ] 完整文档可用

---

## 🔍 审查清单

### 代码审查

**必须检查**:
- [ ] 代码逻辑正确
- [ ] 边界条件处理
- [ ] 错误处理完善
- [ ] 性能无明显问题
- [ ] 安全无明显漏洞
- [ ] 测试覆盖充分
- [ ] 文档清晰完整

### 架构审查

**必须检查**:
- [ ] 符合设计原则（SOLID、KISS、DRY）
- [ ] 模块边界清晰
- [ ] 依赖关系合理
- [ ] 扩展性考虑
- [ ] 维护性考虑

---

## 📌 豁免机制

### 豁免条件

**允许豁免的情况**:
- MVP阶段可豁免非核心DoD项
- 技术debt明确记录并有偿还计划
- 紧急bug修复可豁免部分流程

**豁免流程**:
1. 明确记录豁免原因
2. 评估风险和影响
3. 制定偿还计划
4. 获得团队批准
5. 在Issue/PR中标记

**禁止豁免**:
- [ ] 功能验收标准
- [ ] 阻塞性bug修复
- [ ] 安全漏洞修复
- [ ] 核心测试覆盖

---

## 🎯 持续改进

### DoD演进

**审查周期**:
- Sprint回顾会议：检查DoD适用性
- 每月评审：更新DoD标准
- 里程碑完成：总结经验教训

**改进来源**:
- 团队反馈
- 生产问题复盘
- 行业最佳实践
- 工具升级

---

**最后更新**: 2025-10-27
**维护者**: EvolvAI Team
**反馈渠道**: GitHub Issues或团队会议
