# ADR-003: å·¥å…·è°ƒç”¨é“¾è·¯ç®€åŒ– - ToolExecutionEngine

**çŠ¶æ€**: [APPROVED]
**æ—¥æœŸ**: 2025-10-27
**å†³ç­–è€…**: EvolvAI Team
**å½±å“èŒƒå›´**: Epic-001, SerenaAgent æ ¸å¿ƒæ¶æ„

---

## ğŸ“‹ èƒŒæ™¯

### é—®é¢˜é™ˆè¿°

åœ¨åˆ†æ SerenaAgent ä¸ MCP çš„é›†æˆæ¶æ„æ—¶ï¼Œå‘ç°å½“å‰å·¥å…·è°ƒç”¨é“¾è·¯è¿‡äºå¤æ‚ï¼š

```
AI Client â†’ FastMCP â†’ MCP Tool wrapper â†’ Tool.apply_ex()
â†’ SerenaAgent.execute_task() â†’ ThreadPoolExecutor â†’ Tool.apply()
```

**7 å±‚è°ƒç”¨é“¾è·¯**å¯¼è‡´ï¼š
1. **å®¡è®¡å›°éš¾**ï¼štoken æ¶ˆè€—è·¯å¾„åˆ†æ•£ï¼Œæ— æ³•æ¸…æ™°è¿½è¸ª TPST
2. **èŒè´£æ··ä¹±**ï¼š`Tool.apply_ex()` æ··æ‚ 6 ç§èŒè´£ï¼ˆæ£€æŸ¥ã€æ—¥å¿—ã€å¼‚å¸¸ã€ç»Ÿè®¡ã€çº¿ç¨‹æ± ã€æ‰§è¡Œï¼‰
3. **æ‰©å±•å›°éš¾**ï¼šEpic-001 çš„çº¦æŸç³»ç»Ÿéœ€è¦åœ¨å¤šå¤„æ³¨å…¥æ£€æŸ¥ç‚¹
4. **æ€§èƒ½å¼€é”€**ï¼šæ¯å±‚éƒ½æœ‰åŒ…è£…å’Œè½¬æ¢æˆæœ¬

### EvolvAI çš„æ ¸å¿ƒå®šä½

EvolvAI çš„æ ¸å¿ƒä»·å€¼æ˜¯ **TPST (Tokens Per Solved Task) ä¼˜åŒ–**ï¼Œè¿™è¦æ±‚ï¼š
- **æ¸…æ™°çš„ token æ¶ˆè€—è·¯å¾„**ï¼šå¿…é¡»çŸ¥é“æ¯ä¸ªç¯èŠ‚æ¶ˆè€—äº†å¤šå°‘ token
- **å¯å®¡è®¡çš„æ‰§è¡Œè¿‡ç¨‹**ï¼šèƒ½å¤Ÿåˆ†æå“ªäº›æ“ä½œå¯¼è‡´ token æµªè´¹
- **å¯ä¼˜åŒ–çš„æ‰§è¡Œå¼•æ“**ï¼šèƒ½å¤Ÿæ³¨å…¥çº¦æŸã€æ‰¹å¤„ç†ç­‰ä¼˜åŒ–ç­–ç•¥

å½“å‰çš„ 7 å±‚é“¾è·¯**æ— æ³•æ»¡è¶³å®¡è®¡å’Œä¼˜åŒ–éœ€æ±‚**ã€‚

---

## ğŸ¯ å†³ç­–

### æ ¸å¿ƒå†³ç­–

åˆ›å»ºç»Ÿä¸€çš„ **ToolExecutionEngine**ï¼Œå°†å·¥å…·è°ƒç”¨é“¾è·¯ä» **7 å±‚ç®€åŒ–åˆ° 4 å±‚**ï¼š

```
AI Client â†’ FastMCP â†’ ToolExecutionEngine â†’ Tool.apply()
```

### ToolExecutionEngine èŒè´£

```python
class ToolExecutionEngine:
    """
    ç»Ÿä¸€å·¥å…·æ‰§è¡Œå¼•æ“

    èŒè´£ï¼š
    1. ç»Ÿä¸€æ‰§è¡Œæµç¨‹ï¼ˆ4 ä¸ªé˜¶æ®µï¼špre-validation â†’ pre-execution â†’ execution â†’ post-executionï¼‰
    2. é›†æˆçº¦æŸæ£€æŸ¥ï¼ˆEpic-001 çš„ ExecutionPlanã€Constitutional Constraintsï¼‰
    3. å®¡è®¡è¿½è¸ªï¼ˆå®Œæ•´çš„ ExecutionContextï¼Œæ”¯æŒ TPST åˆ†æï¼‰
    4. çº¿ç¨‹æ± ç®¡ç†ï¼ˆå¼‚æ­¥æ‰§è¡Œï¼Œä» SerenaAgent è¿ç§»è¿‡æ¥ï¼‰
    5. æ€§èƒ½ç›‘æ§ï¼ˆè¯†åˆ«æ…¢å·¥å…·ã€token æµªè´¹ï¼‰
    """
```

### æ‰§è¡Œæµç¨‹

```yaml
Phase 1 - Pre-validation:
  - æ£€æŸ¥å·¥å…·æ¿€æ´»çŠ¶æ€
  - æ£€æŸ¥é¡¹ç›®è¦æ±‚
  - æ£€æŸ¥ Language Server çŠ¶æ€

Phase 2 - Pre-execution (Epic-001):
  - ExecutionPlan éªŒè¯ï¼ˆfeature flag æ§åˆ¶ï¼‰
  - Constitutional Constraints æ£€æŸ¥
  - Batching æœºä¼šæ£€æµ‹

Phase 3 - Execution:
  - Token ä¼°ç®—ï¼ˆæ‰§è¡Œå‰ï¼‰
  - çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œ
  - Token ç»Ÿè®¡ï¼ˆæ‰§è¡Œåï¼‰

Phase 4 - Post-execution:
  - æ—¥å¿—è®°å½•
  - ç»Ÿè®¡ä¸ŠæŠ¥
  - æ€§èƒ½ç›‘æ§
```

### ExecutionContextï¼ˆå®¡è®¡æ ¸å¿ƒï¼‰

```python
@dataclass
class ExecutionContext:
    """æ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆå®Œæ•´çš„å®¡è®¡ä¿¡æ¯ï¼‰"""
    tool_name: str
    kwargs: dict[str, Any]
    execution_plan: Any | None

    # æ—¶é—´è¿½è¸ª
    start_time: float
    end_time: float
    phase: ExecutionPhase

    # çº¦æŸæ£€æŸ¥ï¼ˆEpic-001ï¼‰
    constraint_violations: list[str]
    should_batch: bool

    # æ‰§è¡Œç»“æœ
    result: str | None
    error: Exception | None

    # Token è¿½è¸ªï¼ˆTPST æ ¸å¿ƒï¼‰
    estimated_tokens: int
    actual_tokens: int

    def to_audit_record(self) -> dict:
        """è½¬æ¢ä¸ºå®¡è®¡è®°å½•ï¼ˆç”¨äº TPST åˆ†æï¼‰"""
        return {
            'tool': self.tool_name,
            'phase': self.phase.value,
            'duration': self.end_time - self.start_time,
            'tokens': self.actual_tokens,
            'success': self.error is None,
            'constraints': self.constraint_violations,
            'batched': self.should_batch
        }
```

---

## ğŸ¨ æ¶æ„å˜åŒ–

### ç®€åŒ–å‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Client                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastMCP Server                          â”‚ â† Layer 1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MCP Tool (execute_fn wrapper)           â”‚ â† Layer 2 âŒ å†—ä½™
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tool.apply_ex()                         â”‚ â† Layer 3 âŒ èŒè´£è¿‡å¤š
â”‚ - æ£€æŸ¥æ¿€æ´»çŠ¶æ€                           â”‚
â”‚ - æ£€æŸ¥é¡¹ç›®                               â”‚
â”‚ - æ£€æŸ¥ LSP                               â”‚
â”‚ - æ—¥å¿—è®°å½•                               â”‚
â”‚ - å¼‚å¸¸å¤„ç†                               â”‚
â”‚ - ç»Ÿè®¡è®°å½•                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SerenaAgent.execute_task()              â”‚ â† Layer 4 âŒ ç®€å•åŒ…è£…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ThreadPoolExecutor                      â”‚ â† Layer 5 âŒ å¯åˆå¹¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tool.apply() - ä¸šåŠ¡é€»è¾‘                  â”‚ â† Layer 6 âœ… å¿…éœ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç®€åŒ–å

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ AI Client                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FastMCP Server                          â”‚ â† Layer 1 âœ… åè®®å±‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ToolExecutionEngine                     â”‚ â† Layer 2 â­ ç»Ÿä¸€å…¥å£
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Pre-validation                  â”‚   â”‚
â”‚ â”‚ - å·¥å…·æ¿€æ´»æ£€æŸ¥                   â”‚   â”‚
â”‚ â”‚ - é¡¹ç›®æ£€æŸ¥                       â”‚   â”‚
â”‚ â”‚ - LSP æ£€æŸ¥                       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Pre-execution (Epic-001)        â”‚   â”‚
â”‚ â”‚ - ExecutionPlan éªŒè¯            â”‚   â”‚
â”‚ â”‚ - Constraints æ£€æŸ¥              â”‚   â”‚
â”‚ â”‚ - Batching ä¼˜åŒ–                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Execution                       â”‚   â”‚
â”‚ â”‚ - Token ä¼°ç®—                    â”‚   â”‚
â”‚ â”‚ - çº¿ç¨‹æ± æ‰§è¡Œ                     â”‚   â”‚
â”‚ â”‚ - Token ç»Ÿè®¡                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Post-execution                  â”‚   â”‚
â”‚ â”‚ - æ—¥å¿—è®°å½•                       â”‚   â”‚
â”‚ â”‚ - ç»Ÿè®¡ä¸ŠæŠ¥                       â”‚   â”‚
â”‚ â”‚ - æ€§èƒ½ç›‘æ§                       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚ ExecutionContext (å®Œæ•´å®¡è®¡ä¿¡æ¯)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Tool.apply() - ä¸šåŠ¡é€»è¾‘                  â”‚ â† Layer 3 âœ… å¿…éœ€
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å½±å“åˆ†æ

### æ­£é¢å½±å“

1. **å®¡è®¡èƒ½åŠ›æå‡** â­â­â­â­â­
   - å®Œæ•´çš„ ExecutionContext è®°å½•
   - æ¸…æ™°çš„ token æ¶ˆè€—è·¯å¾„
   - æ”¯æŒ TPST ç²¾ç¡®åˆ†æ

2. **Epic-001 é›†æˆç®€åŒ–** â­â­â­â­â­
   - å•ä¸€æ³¨å…¥ç‚¹ï¼ˆ`_pre_execution_with_constraints`ï¼‰
   - Feature flag æ§åˆ¶ï¼ˆ`enable_constraints`ï¼‰
   - ä¸éœ€è¦ä¿®æ”¹æ¯ä¸ªå·¥å…·

3. **ä»£ç å¯ç»´æŠ¤æ€§æå‡** â­â­â­â­
   - èŒè´£é›†ä¸­ï¼ˆåˆ†æ•£çš„ 6 ç§èŒè´£ â†’ ç»Ÿä¸€å¼•æ“ï¼‰
   - æ˜“äºç†è§£ï¼ˆ4 ä¸ªæ¸…æ™°çš„æ‰§è¡Œé˜¶æ®µï¼‰
   - æ˜“äºæµ‹è¯•ï¼ˆç»Ÿä¸€çš„æ‰§è¡Œæµç¨‹ï¼‰

4. **æ€§èƒ½ç›‘æ§èƒ½åŠ›** â­â­â­â­
   - è¯†åˆ«æ…¢å·¥å…·ï¼ˆduration > thresholdï¼‰
   - è¯†åˆ« token æµªè´¹ï¼ˆactual > estimatedï¼‰
   - ç”Ÿæˆä¼˜åŒ–å»ºè®®ï¼ˆbatching opportunitiesï¼‰

### è´Ÿé¢å½±å“

1. **ä»£ç é‡å¢åŠ ** â­â­
   - ToolExecutionEngine: ~150 lines
   - ExecutionContext: ~30 lines
   - æ€»è®¡ï¼š+180 lines

   **ç¼“è§£**ï¼šä»£ç é‡è™½å¢åŠ ï¼Œä½†å¤æ‚åº¦é™ä½ï¼ˆé›†ä¸­ vs åˆ†æ•£ï¼‰

2. **é‡æ„é£é™©** â­â­â­
   - éœ€è¦ä¿®æ”¹ Tool.apply_ex()
   - éœ€è¦ä¿®æ”¹ SerenaAgent åˆå§‹åŒ–
   - å¯èƒ½å½±å“ç°æœ‰å·¥å…·

   **ç¼“è§£**ï¼š
   - å……åˆ†çš„å›å½’æµ‹è¯•
   - æ¸è¿›å¼è¿ç§»
   - ä¿æŒå‘åå…¼å®¹

3. **å­¦ä¹ æˆæœ¬** â­â­
   - æ–°çš„æ‰§è¡Œæµç¨‹
   - æ–°çš„ ExecutionContext æ¦‚å¿µ

   **ç¼“è§£**ï¼š
   - æ¸…æ™°çš„æ–‡æ¡£
   - 4 é˜¶æ®µæ˜“äºç†è§£
   - KISS åŸåˆ™ï¼ˆç®€å•é€šç”¨ï¼‰

---

## ğŸ¯ å®æ–½è®¡åˆ’

### Phase 0: é“¾è·¯ç®€åŒ–ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰

```yaml
Story 0.1: å®ç° ToolExecutionEngine
  - åˆ›å»º ExecutionContext æ•°æ®ç±»
  - å®ç° 4 é˜¶æ®µæ‰§è¡Œæµç¨‹
  - å®ç°å®¡è®¡æ—¥å¿—
  - å®ç° TPST åˆ†ææ¥å£
  å·¥æœŸ: 5 å¤©
  é£é™©: ğŸŸ¡ ä¸­

Story 0.2: é›†æˆåˆ° SerenaAgent
  - ä¿®æ”¹ Tool.apply_ex() å§”æ‰˜ç»™æ‰§è¡Œå¼•æ“
  - ç§»é™¤ SerenaAgent.execute_task()
  - æ›´æ–° MCP é€‚é…å™¨
  - æ·»åŠ  feature flag æ§åˆ¶
  å·¥æœŸ: 3 å¤©
  é£é™©: ğŸ”´ é«˜

Story 0.3: å›å½’æµ‹è¯•
  - è¿è¡Œæ‰€æœ‰ç°æœ‰æµ‹è¯•
  - éªŒè¯å·¥å…·è°ƒç”¨è¡Œä¸ºä¸å˜
  - éªŒè¯å®¡è®¡æ—¥å¿—æ­£ç¡®æ€§
  å·¥æœŸ: 2 å¤©
  é£é™©: ğŸŸ¢ ä½
```

### ä¸ Epic-001 çš„å…³ç³»

Phase 0 å®Œæˆåï¼ŒEpic-001 çš„ 4 ä¸ª Features å°†**ç›´æ¥æ³¨å…¥åˆ° ToolExecutionEngine**ï¼š

```python
class ToolExecutionEngine:
    def _pre_execution_with_constraints(self, tool, ctx):
        """Epic-001 ç»Ÿä¸€å…¥å£"""

        # Feature 1: ExecutionPlan Validation
        if not self._constraint_engine.validate_plan(ctx.execution_plan):
            raise InvalidExecutionPlanError(...)

        # Feature 2-4: Constitutional Constraints + Batching
        violations = self._constraint_engine.check_constraints(tool, ctx.kwargs)
        if violations:
            raise ConstraintViolationError(...)

        if self._constraint_engine.should_batch(tool, ctx.kwargs):
            ctx.result = self._constraint_engine.execute_batched(...)
            raise BatchExecutionCompleted()
```

---

## ğŸ”„ å¯é€†æ€§

### å›æ»šç­–ç•¥

å¦‚æœ ToolExecutionEngine å‡ºç°ä¸¥é‡é—®é¢˜ï¼Œå¯ä»¥å›æ»šåˆ°åŸæ¥çš„æ¶æ„ï¼š

1. **Feature flag ç¦ç”¨**ï¼š`enable_execution_engine = False`
2. **æ¢å¤ Tool.apply_ex()**ï¼šä¿ç•™åŸæ¥çš„å®ç°ä½œä¸º fallback
3. **ä¿ç•™ SerenaAgent.execute_task()**ï¼šæš‚ä¸åˆ é™¤ï¼Œä¿æŒå…¼å®¹

### ç°åº¦å‘å¸ƒ

- Week 1: ä»…åœ¨æµ‹è¯•ç¯å¢ƒå¯ç”¨
- Week 2: åœ¨éƒ¨åˆ†å·¥å…·å¯ç”¨ï¼ˆä½é£é™©å·¥å…·ï¼‰
- Week 3: å…¨é‡å¯ç”¨
- Week 4: ç§»é™¤æ—§ä»£ç 

---

## ğŸ“š å‚è€ƒèµ„æ–™

### è®¾è®¡åŸåˆ™

- **KISS (Keep It Simple, Stupid)**: ç®€å•é€šç”¨ä¼˜äºå¤æ‚ç²¾ç¡®
- **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸ªç±»åªæœ‰ä¸€ä¸ªå˜åŒ–çš„ç†ç”±
- **å¼€é—­åŸåˆ™**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

### ç›¸å…³ ADR

- [ADR-001: Graph-of-Thought over Sequential Thinking](001-graph-of-thought-over-sequential-thinking.md)
- [ADR-002: Monorepo with Epic-003 Future Split](002-monorepo-with-epic-003-future-split.md)

### å‚è€ƒå®ç°

- **è´£ä»»é“¾æ¨¡å¼**ï¼ˆChain of Responsibilityï¼‰
- **ä¸­é—´ä»¶æ¨¡å¼**ï¼ˆMiddleware Patternï¼‰
- **ç®¡é“æ¨¡å¼**ï¼ˆPipeline Patternï¼‰

---

## ğŸ¤” æ›¿ä»£æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šä¿æŒç°çŠ¶ + Epic-001 æ³¨å…¥

**æè¿°**ï¼šåœ¨ Tool.apply_ex() ä¸­ç›´æ¥æ³¨å…¥ Epic-001 çš„çº¦æŸæ£€æŸ¥

**ä¼˜ç‚¹**ï¼š
- ä¸éœ€è¦é‡æ„
- é£é™©æœ€ä½

**ç¼ºç‚¹**ï¼š
- æ— æ³•è§£å†³å®¡è®¡é—®é¢˜
- æ— æ³•è§£å†³é“¾è·¯å¤æ‚é—®é¢˜
- ä¸ç¬¦åˆ EvolvAI çš„æ ¸å¿ƒå®šä½

**å†³ç­–**ï¼šâŒ æ‹’ç»ï¼ˆä¸ç¬¦åˆé¡¹ç›®å®šä½ï¼‰

### æ–¹æ¡ˆ Bï¼šè£…é¥°å™¨æ¨¡å¼

**æè¿°**ï¼šä¸ºæ¯ä¸ªå·¥å…·æ·»åŠ è£…é¥°å™¨å®ç°çº¦æŸ

**ä¼˜ç‚¹**ï¼š
- ç»†ç²’åº¦æ§åˆ¶
- æ¸è¿›å¼è¿ç§»

**ç¼ºç‚¹**ï¼š
- éœ€è¦ä¿®æ”¹æ¯ä¸ªå·¥å…·
- æ— æ³•ç»Ÿä¸€å®¡è®¡
- ä¸ç¬¦åˆ KISS åŸåˆ™

**å†³ç­–**ï¼šâŒ æ‹’ç»ï¼ˆè¿‡äºå¤æ‚ï¼‰

### æ–¹æ¡ˆ Cï¼šToolExecutionEngineï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹**ï¼š
- ç»Ÿä¸€æ‰§è¡Œå…¥å£
- å®Œæ•´å®¡è®¡èƒ½åŠ›
- æ˜“äºæ‰©å±•
- ç¬¦åˆ KISS åŸåˆ™

**ç¼ºç‚¹**ï¼š
- éœ€è¦é‡æ„
- çŸ­æœŸé£é™©è¾ƒé«˜

**å†³ç­–**ï¼šâœ… é‡‡çº³ï¼ˆæœ€ç¬¦åˆé¡¹ç›®å®šä½ï¼‰

---

## âœ… å†³ç­–ç¡®è®¤

- [x] **å†³ç­–å·²æ‰¹å‡†** - 2025-10-27
- [x] **æ¶æ„è¯„å®¡é€šè¿‡** - EvolvAI Team
- [ ] **å®æ–½å¼€å§‹** - é¢„è®¡ 2025-10-28
- [ ] **Phase 0 å®Œæˆ** - é¢„è®¡ 2025-11-03
- [ ] **ç”Ÿäº§éƒ¨ç½²** - é¢„è®¡ 2025-11-10

---

**æœ€åæ›´æ–°**: 2025-10-27
**æ›´æ–°äºº**: EvolvAI Team
