# EvolvAI 架构决策记录 (ADR)

## 📋 文档说明
本记录使用 [Architecture Decision Record (ADR)] 格式，记录 EvolvAI 项目的重要架构决策。

---

## ADR-001: 项目定位重定义

**Date**: 2024-01-26
**Status**: 已接受
**Tags**: architecture, positioning, strategy

### 上下文
原 Serena Agent 定位为语义代码分析和编辑工具，但经过深入分析发现：
1. 与 Claude Code 等 AI 助手功能重叠
2. 无法解决 AI 助手的实际痛点（高 Token 消耗、响应缓慢、记忆缺失）
3. 市场定位模糊，缺乏独特价值

### 决策
**将项目重定位为 "AI 开发环境学习助手"，专注于：**
- 🧠 记忆增强：记住用户环境偏好和编码标准
- ⚡ 性能优化：为 AI 助手提供缓存和加速
- 🎯 智能建议：基于学习数据优化工具选择
- 💾 上下文提供：生成结构化上下文包

### 理由
1. **市场空缺**：没有专门解决 AI 助手环境感知问题的工具
2. **技术优势**：可复用 Serena 的 LSP 分析能力
3. **用户价值**：显著提升 AI 助手的使用体验

### 结果
- 项目更名：Serena Agent → EvolvAI
- 价值主张：让 AI 编程助手理解你的开发环境和编码习惯
- 核心功能：环境学习 + AI 优化 + 持续记忆

---

## ADR-002: 工具保留策略

**Date**: 2024-01-26
**Status**: 已接受
**Tags**: tools, architecture, performance

### 上下文
讨论是否保留传统代码编辑工具（symbol_tools.py, file_tools.py, cmd_tools.py）：

**观点A（移除）**：
- AI 助手已经有这些能力
- 与 EvolvAI 核心定位不符
- 重复造轮子

**观点B（保留增强）**：
- AI 助手存在实际痛点：
  - 💰 Token 消耗巨大
  - 🐌 响应缓慢
  - 🧠 记忆缺失
  - ⚡ 工具选择不当

### 决策
**保留并增强传统工具，但重新定位边界：**

1. **角色重定义**：从"编辑工具" → "AI 增强工具"
2. **输出策略**：默认输出 diff/patch，需要确认才执行
3. **性能优化**：智能缓存、并行搜索、最优工具选择
4. **边界原则**：不替代 IDE/LSP，专注跨文件项目级分析

### 理由
1. **技术水平**：显著改善 AI 助手性能问题
2. **差异化**：与纯 AI 助手形成互补关系
3. **用户价值**：解决真实使用痛点

### 结果
- 保留所有工具模块但重构为智能增强版本
- 实现智能缓存和性能优化
- 默认建议模式，可选择执行
- 与 AI 助手形成协同关系

---

## ADR-003: 存储架构选择

**Date**: 2024-01-26
**Status**: 已接受
**Tags**: storage, database, caching, architecture

### 上下文
需要选择数据存储方案，考虑：
1. 索引数据持久化
2. 内容缓存策略
3. 配置和偏好存储
4. 兼顾性能和可靠性

### 决策
**采用混合存储架构：**

1. **SQLite**：结构化数据存储
   - 文件索引表
   - 符号索引表
   - 配置和偏好
   - 统计和监控数据

2. **内存缓存**：热点数据缓存
   - LRU 策略
   - 内容哈希键值
   - 可配置大小限制

3. **文件系统**：大型内容存储
   - 内容哈希文件名
   - 分层目录结构
   - 自动清理机制

### 理由
1. **SQLite 优势**：
   - 无需额外服务
   - ACID 特性保证数据一致性
   - 优秀的 Python 支持
   - 便于查询和统计

2. **内存缓存优势**：
   - 极快访问速度
   - 减少数据库查询
   - 支持复杂缓存策略

3. **文件系统优势**：
   - 支持大型内容存储
   - 利用操作系统缓存
   - 跨进程共享

### 结果
- 统一存储位置：`$PROJECT_ROOT/.evolvai/`
- 三层存储架构：SQLite + 内存 + 文件
- 自动备份和恢复机制

---

## ADR-004: AI 集成架构

**Date**: 2024-01-26
**Status**: 已接受
**Tags**: integration, api, mcp, architecture

### 上下文
需要确定与 AI 助手的集成方式：
1. **MCP 协议**：标准化工具接口
2. **独立服务**：HTTP/gRPC 服务
3. **IDE 插件**：深度集成到特定 IDE

### 决策
**采用分层集成架构：**

1. **MCP 协议**（主要接口）
   - 标准化工具调用
   - 权限和安全控制
   - 跨平台兼容性

2. **独立服务**（辅助接口）
   - HTTP API：现代 Web 应用
   - gRPC：高性能调用
   - CLI 工具：命令行接口

3. **IDE 插件**（可选增强）
   - 可视化界面
   - 便利操作
   - 不含核心逻辑

### 理由
1. **MCP 优势**：
   - Claude Code/Cursor 支持良好
   - 协议标准化，未来兼容性好
   - 内置安全机制

2. **独立服务优势**：
   - 不被单一生态绑定
   - 便于调试和测试
   - 支持多样化使用场景

3. **IDE 插件优势**：
   - 用户体验优化
   - 可视化展示
   - 低实现成本

### 结果
- 核心逻辑统一，多接口访问
- MCP 为主流接口
- 保持和发展灵活性

---

## ADR-005: 性能优化策略

**Date**: 2024-01-26
**Status**: 已接受
**Tags**: performance, optimization, caching

### 上下文
需要定义性能优化目标和策略：
1. 搜索性能：rg vs grep vs find
2. 并发处理：多线程 vs 单线程
3. 缓存策略：LRU vs TTL vs 手动
4. 索引策略：全量 vs 增量

### 决策
**采用智能优化策略：**

1. **智能工具选择**：
   - 根据文件数量和查询复杂度选择工具
   - large projects (>1k files): ripgrep 优先
   - complex regex: rg 优先
   - simple string: grep 优先
   - filename: find/fd 优先

2. **自适应并发行**：
   - 根据系统资源动态调整线程数
   - I/O 密集和 CPU 密集分离处理
   - 大项目采用分层并发

3. **多层缓存**：
   - 内存缓存：热点数据，LRU 策略
   - 数据库缓存：索引和元数据
   - 文件系统缓存：结果持久化

4. **增量索引**：
   - 文件监听：实时变更检测
   - 智能批量：批量更新策略
   - 版本控制：基于时间戳和哈希

### 理由
1. **自适应性**：不同项目规模需要不同策略
2. **可测量**：每种选择都有量化指标
3. **可维护**：规则化而非硬编码

### 结果
- 实现性能监控和统计
- 自适应算法选择
- 量化性能提升效果

---

## 🔄 待定事项

### **ADR-006: 语言服务器支持范围**
**状态**: 草案中
**内容**: 应该支持哪些编程语言服务器

### **ADR-007: 商业模式设计**
**状态**: 草案中
**内容**: 开源免费 vs 企业功能 vs 云服务

### **ADR-008: 用户界面策略**
**状态**: 草案中
**内容**: CLI vs Web Dashboard vs IDE 插件优先级

---

*文档维护者*
*文档版本*: v1.0*
*最后更新*: 2024-01-26*