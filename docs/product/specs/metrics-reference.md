# Metrics Reference - TPST 指标权威参考

**版本**: v0.1 (假设性目标)  
**创建日期**: 2025-10-27  
**状态**: [DRAFT] - 待实验验证  
**维护者**: EvolvAI Team

---

## ⚠️ 重要说明

**本文档中的所有指标目标都是基于经验假设，尚未通过实验验证。**

- ✅ 用途：统一项目中 TPST 目标的定义，作为 SSOT (Single Source of Truth)
- ⚠️  状态：假设性目标，需要通过基准测试和对比实验验证
- 🔄 演进：随着实际测量数据的获得，本文档将持续更新

---

## 📊 TPST 定义

### 核心指标

**TPST (Tokens Per Solved Task)** = 总消耗 Token 数 / 成功解决的任务数

```python
TPST = (Total_Input_Tokens + Total_Output_Tokens) / Successful_Tasks_Count
```

### 组成部分

```
总 Token 消耗
├── 思考 Token (Thinking Tokens)
│   ├── 分析思考
│   ├── 计划制定
│   ├── 错误调试推理
│   └── 自我反思
├── 执行 Token (Execution Tokens)
│   ├── 代码生成
│   ├── 文档编写
│   └── 命令执行
└── 返工 Token (Rework Tokens)
    ├── 错误修复
    ├── 重新规划
    └── 重复操作
```

### 任务定义

**成功解决的任务 (Successful Task)** 定义：
- ✅ 满足用户需求
- ✅ 通过所有测试
- ✅ 无需进一步返工
- ❌ 不包括失败或放弃的任务

---

## 🎯 假设性目标体系

### 基线假设 (无约束 AI)

基于经验观察，未优化的 AI 辅助编程：

| 指标 | 假设值 | 来源 |
|------|--------|------|
| 平均 TPST | ~50,000 tokens/task | 经验观察 |
| 思考 token 占比 | ~40% | 估算 |
| 平均返工次数 | 3-5 次/task | 经验值 |
| 首次成功率 | ~30% | 估算 |

**注意**: 这些基线值需要通过实际测量建立。

### MVP 目标 (Week 2)

**Epic-001 单独效果** (假设)：

| 指标 | 目标值 | 改进幅度 |
|------|--------|---------|
| TPST | ~35,000 tokens/task | **-30%** |
| 首次成功率 | ≥70% | 从 30% 提升 |
| 返工次数 | ≤2 次/task | 从 3-5 次降低 |
| 盲目搜索占比 | ≤10% | 从 30% 降低 |

**假设依据**：
- safe_search 强制限制减少无效搜索：-10%
- safe_edit 批量操作减少返工往返：-10%
- safe_exec 进程管理避免失控重试：-5%
- ExecutionPlan 验证减少执行错误：-5%

### 完整版目标 (Week 6)

**三 Epic 协同效果** (假设)：

| Epic | 贡献 | 目标 TPST | 累计改进 |
|------|------|-----------|---------|
| 基线 | - | 50,000 | - |
| Epic-001 (Constraints) | -30% | 35,000 | -30% |
| + Epic-002 (Standards) | -10% | 31,500 | -37% |
| + Epic-003 (GoT) | -30% | 22,050 | -55.9% |
| + 协同增益 | +6% | **25,000** | **-50%** |

**各 Epic 假设贡献**（按开发顺序）：

1. **Epic-001 (Behavior Constraints)**: -30%
   - safe_search 限制无效搜索：-10%
   - safe_edit 批量操作减少往返：-10%
   - safe_exec 进程管理避免失控：-5%
   - ExecutionPlan 验证减少错误：-5%

2. **Epic-002 (Project Standards)**: -10%
   - 文档位置自动建议：-5%
   - 结构模板减少返工：-3%
   - 规范校验早期拦截：-2%

3. **Epic-003 (GoT Engine)**: -30%
   - 思考 token 从 40% 降至 20%
   - 并行分支探索提升效率
   - 早停策略减少无效探索

4. **协同增益**: +6% (重叠损失)
   - Epic-001 与 Epic-003 在错误减少上有重叠
   - Epic-002 与 Epic-003 在规划优化上有重叠
   - 实际累计效果约 -50%（保守）至 -70%（理想）

### 理想目标 (长期)

**持续优化后** (假设)：

| 指标 | 目标值 | 改进幅度 |
|------|--------|---------|
| TPST | ~15,000 tokens/task | **-70%** |
| 思考占比 | ≤15% | 从 40% 降低 |
| 思考回合数 | ≤2 轮 | 从 5-8 轮降低 |
| 首次成功率 | ≥90% | 从 30% 提升 |
| 平均返工次数 | ≤1 次 | 从 3-5 次降低 |

**假设依据**：
- Case-based learning 提升策略选择
- 小模型缓存减少重复计算
- 模式匹配加速常见任务

---

## 🧪 实验验证计划

### 基线测量

**目标**: 建立真实的基线 TPST 数据

**方法**:
```yaml
测试场景:
  - 小型项目 (< 1000 行代码)
  - 中型项目 (1000-10000 行)
  - 大型项目 (> 10000 行)

任务类型:
  - 搜索型: 找到特定函数/类
  - 编辑型: 修改现有代码
  - 重构型: 大规模代码重组

测量指标:
  - 总 token 数 (input + output)
  - 思考 token 占比
  - 返工次数
  - 任务成功率
  - 完成时间
```

**工具**: 
- Token 计数器: `tiktoken`
- 日志收集: MCP event logging
- 对比脚本: `docs/testing/benchmarks/baseline-tpst.sh`

### MVP 验证 (Week 2)

**目标**: 验证 Epic-001 单独效果

**实验设计**:
```yaml
对照组: 无行为约束 (原始 AI 助手操作)
实验组: 启用 Epic-001 (safe_search/edit/exec)

测试任务: 9 个 (3 仓库 × 3 任务类型)
重复次数: 每任务 5 次
样本量: 45 次 × 2 组 = 90 次测量

成功标准:
  - TPST 降低 ≥ 30%
  - p < 0.05 (统计显著性)
  - 首次成功率 ≥ 70%
  - 返工次数降低 ≥ 40%
```

### 完整版验证 (Week 10)

**目标**: 验证三 Epic 协同效果

**实验设计**:
```yaml
对照组: 无任何约束
实验组1: 仅 Epic-001
实验组2: Epic-001 + Epic-002
实验组3: Epic-001 + Epic-002 + Epic-003 (完整系统)

测试任务: 同 MVP，增加文档任务
样本量: 90 次 × 4 组 = 360 次测量

成功标准:
  - 实验组3 TPST 降低 ≥ 50% (保守目标)
  - 各 Epic 贡献度符合假设 (±10%)
  - 协同效应可观察到（正向或负向）
  - 理想情况: TPST 降低达到 -70%
```

---

## 📈 指标追踪与演进

### 版本历史

| 版本 | 日期 | 状态 | 主要变更 |
|------|------|------|---------|
| v0.1 | 2025-10-27 | 假设性目标 | 初始版本，基于经验假设 |
| v0.2 | 待定 | 待验证 | 基线测量完成后更新 |
| v1.0 | 待定 | 验证通过 | MVP 实验验证后确定 |

### 假设调整记录

**预期调整场景**:
1. 基线 TPST 可能高于或低于 50,000
2. 各 Epic 贡献度可能与假设有偏差
3. 协同增益可能为负（冲突）或更大（超预期）

**调整原则**:
- 保留假设历史，不覆盖
- 记录实际测量数据
- 分析偏差原因
- 调整后续目标

---

## 🔗 相关文档

### 引用本文档的文档

- **产品定义**: `docs/product/definition/product-definition-v1.md`
- **Epic-001**: `docs/product/epics/epic-001-behavior-constraints/README.md`
- **Epic-002**: `docs/product/epics/epic-002-project-standards/README.md`
- **Epic-003**: `docs/product/epics/epic-003-graph-of-thought/README.md`
- **三 Epic 关系**: `docs/product/roadmap/three-epics-relationship.md`
- **DoD 清单**: `docs/development/standards/definition-of-done.md`

### 相关测试文档

- **基准测试脚本**: `docs/testing/benchmarks/baseline-tpst.sh` (待创建)
- **对比实验报告**: `docs/testing/reports/tpst-comparison-report.md` (待创建)
- **统计分析方法**: `docs/testing/plans/statistical-analysis.md` (待创建)

---

## 💡 使用指南

### 产品文档中如何引用

**推荐格式**:
```markdown
> **TPST 目标**: 降低 50%（假设性，待验证）
> 
> 详见权威指标定义：[Metrics Reference](../specs/metrics-reference.md)
```

### DoD 中如何使用

**推荐格式**:
```markdown
**TPST 验证标准**:
- [ ] 对比基线 TPST 降低 ≥ 30% (参考: [Metrics Reference](../../product/specs/metrics-reference.md#mvp-目标-week-3))
- [ ] 统计显著性 p < 0.05
- [ ] 思考 token 占比 ≤ 20%
```

---

## ❓ FAQ

### Q1: 为什么所有目标都是假设性的？

**A**: EvolvAI 是全新平台，没有历史数据。这些目标基于：
- 对现有 AI 行为的经验观察
- 类似优化技术的文献参考
- 合理的工程估算

实际效果需要通过实验验证。

### Q2: 如果实际测量与假设偏差很大怎么办？

**A**: 
1. 保留假设历史（不删除）
2. 分析偏差原因（技术 vs 测量方法）
3. 调整目标到现实水平
4. 更新所有引用文档

### Q3: 各 Epic 贡献度是否可能重叠？

**A**: 可能。假设中的 -15% + -10% 不等于 -25%，因为：
- 某些优化可能重叠（如都减少返工）
- 协同增益可能为正或负
- 需要实验测量真实交互效果

### Q4: 为什么要创建这个文档？

**A**: 避免项目内 TPST 目标不一致，提供：
- ✅ 统一权威定义 (SSOT)
- ✅ 清晰的假设依据
- ✅ 实验验证计划
- ✅ 指标演进历史

---

**最后更新**: 2025-10-27  
**下次审查**: MVP 完成后 (Week 3)  
**反馈渠道**: GitHub Issues 或 EvolvAI Team 会议
